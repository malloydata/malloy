---
layout: documentation
title: Malloy Documentation
footer: /generated/footers/patterns/cohorts.html
---

<div class="document">
      <h1>
        <a id="cohort-analysis" class="header-link anchor" href="#cohort-analysis">
          Cohort Analysis
        </a>
      </h1>
    <p>One of the most powerful way of understanding what is happening using data is to use <em>cohort analysis</em>.
Fundamentally, cohort analysis is used to group people into sets and to analyze the success,
attributes or characteristics of that group as compared to the population in general.</p>
<p>To understand this, we're going to use Social Security Administrations birth/name data.</p>
<p>We have a table with <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #001080">name</span></span></code>, <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #001080">gender</span></span></code>, <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #001080">`year`</span></span></code>, <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #001080">state</span></span></code> and the <code class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #001080">`number`</span></span></code> of people born with those
characteristics.</p>
<p>In the simplest form, a cohort calculation is a <a href="percent_of_total.html">percentage of total calculation</a>.
For example, if we were interested in the name 'Billie' as it relates to location. We could look
could filter on 'Billie' and look a states as it relates to total population.</p>
<p>We can see that in the population of the the people named 'Billie', the cohort of the Billies born in
Texas makes up 18% of the total population of Billies.</p>
<pre class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #AF00DB">query</span><span style="color: #000000">: </span><span style="color: #795E26">table</span><span style="color: #000000">(</span><span style="color: #A31515">&#39;bigquery-public-data.usa_names.usa_1910_2013&#39;</span><span style="color: #000000">) -&gt; {</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">where</span><span style="color: #000000">: </span><span style="color: #001080">name</span><span style="color: #000000"> = </span><span style="color: #A31515">&#39;Billie&#39;</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">aggregate</span><span style="color: #000000">: </span><span style="color: #001080">total_population</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #001080">`number`</span><span style="color: #000000">.</span><span style="color: #795E26">sum</span><span style="color: #000000">()</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">nest</span><span style="color: #000000">: </span><span style="color: #001080">main_query</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #AF00DB">group_by</span><span style="color: #000000">: </span><span style="color: #001080">state</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #AF00DB">aggregate</span><span style="color: #000000">: </span><span style="color: #001080">total_population</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #001080">`number`</span><span style="color: #000000">.</span><span style="color: #795E26">sum</span><span style="color: #000000">()</span></span>
<span class="line"><span style="color: #000000">  }</span></span>
<span class="line"><span style="color: #000000">} -&gt; {</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">project</span><span style="color: #000000">:</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #001080">main_query</span><span style="color: #000000">.</span><span style="color: #001080">state</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #001080">main_query</span><span style="color: #000000">.</span><span style="color: #001080">total_population</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #001080">state_as_percent_of_population</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #001080">main_query</span><span style="color: #000000">.</span><span style="color: #001080">total_population</span><span style="color: #000000"> / </span><span style="color: #001080">total_population</span><span style="color: #000000"> * </span><span style="color: #098658">100.0</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">order_by</span><span style="color: #000000">: </span><span style="color: #001080">state_as_percent_of_population</span><span style="color: #000000"> </span><span style="color: #AF00DB">desc</span></span>
<span class="line"><span style="color: #000000">}</span></span></pre><div class="result-outer small">
    <div class="result-controls-bar">
      <span class="result-label">QUERY RESULTS</span>
      <div class="result-controls">
        <button class="result-control"  data-result-kind="html">HTML</button>
        <button class="result-control" selected data-result-kind="json">JSON</button>
        <button class="result-control"  data-result-kind="sql">SQL</button>
      </div>
    </div>
    <div class="result-middle" data-result-kind="html" >
      <div class="result-inner">
        <table style="vertical-align: top; border-collapse: collapse; width: 100%;"><thead><tr><th style="padding: 8px; text-align: left;">state</th><th style="padding: 8px; text-align: right;">total_​population</th><th style="padding: 8px; text-align: right;">state_​as_​percent_​of_​population</th></tr></thead><tbody><tr><td style="padding: 8px; vertical-align: top;"><span>TX</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>23,052</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>18.644</span></td></tr><tr><td style="padding: 8px; vertical-align: top;"><span>OK</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>8,409</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>6.801</span></td></tr><tr><td style="padding: 8px; vertical-align: top;"><span>TN</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>7,368</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>5.959</span></td></tr><tr><td style="padding: 8px; vertical-align: top;"><span>KY</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>6,416</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>5.189</span></td></tr><tr><td style="padding: 8px; vertical-align: top;"><span>AR</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>5,902</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>4.773</span></td></tr><tr><td style="padding: 8px; vertical-align: top;"><span>NC</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>5,726</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>4.631</span></td></tr><tr><td style="padding: 8px; vertical-align: top;"><span>AL</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>5,230</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>4.23</span></td></tr><tr><td style="padding: 8px; vertical-align: top;"><span>MO</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>4,986</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>4.033</span></td></tr><tr><td style="padding: 8px; vertical-align: top;"><span>CA</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>4,830</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>3.906</span></td></tr><tr><td style="padding: 8px; vertical-align: top;"><span>MS</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>4,360</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>3.526</span></td></tr><tr><td style="padding: 8px; vertical-align: top;"><span>OH</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>4,344</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>3.513</span></td></tr><tr><td style="padding: 8px; vertical-align: top;"><span>IL</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>3,830</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>3.098</span></td></tr><tr><td style="padding: 8px; vertical-align: top;"><span>GA</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>3,598</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>2.91</span></td></tr><tr><td style="padding: 8px; vertical-align: top;"><span>LA</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>3,411</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>2.759</span></td></tr><tr><td style="padding: 8px; vertical-align: top;"><span>IN</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>2,926</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>2.367</span></td></tr><tr><td style="padding: 8px; vertical-align: top;"><span>WV</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>2,863</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>2.316</span></td></tr><tr><td style="padding: 8px; vertical-align: top;"><span>PA</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>2,605</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>2.107</span></td></tr><tr><td style="padding: 8px; vertical-align: top;"><span>VA</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>2,467</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>1.995</span></td></tr><tr><td style="padding: 8px; vertical-align: top;"><span>MI</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>2,340</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>1.893</span></td></tr><tr><td style="padding: 8px; vertical-align: top;"><span>KS</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>2,192</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>1.773</span></td></tr></tbody></table>
      </div>
    </div>
    <div class="result-middle" data-result-kind="json" selected>
      <div class="result-inner">
        <pre><pre class="language-json" style="background-color: #FBFBFB"><span class="line"><span style="color: #000000">[</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;state&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;TX&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">23052</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;state_as_percent_of_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">18.644300838718546</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;state&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;OK&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">8409</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;state_as_percent_of_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">6.80114201599793</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;state&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;TN&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">7368</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;state_as_percent_of_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">5.9591882951448145</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;state&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;KY&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">6416</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;state_as_percent_of_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">5.189217169062042</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;state&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;AR&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">5902</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;state_as_percent_of_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">4.773497464433319</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;state&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;NC&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">5726</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;state_as_percent_of_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">4.631149861291966</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;state&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;AL&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">5230</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;state_as_percent_of_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">4.229988434257245</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;state&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;MO&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">4986</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;state_as_percent_of_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">4.032642893538551</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;state&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;CA&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">4830</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;state_as_percent_of_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">3.906471154390534</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;state&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;MS&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">4360</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;state_as_percent_of_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">3.5263383505471486</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;state&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;OH&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">4344</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;state_as_percent_of_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">3.5133976593524805</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;state&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;IL&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">3830</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;state_as_percent_of_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">3.0976779547237565</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;state&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;GA&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">3598</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;state_as_percent_of_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2.9100379324010643</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;state&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;LA&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">3411</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;state_as_percent_of_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2.758793604063377</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;state&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;IN&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2926</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;state_as_percent_of_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2.3665289022249905</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;state&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;WV&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2863</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;state_as_percent_of_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2.315574930645983</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;state&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;PA&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2605</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;state_as_percent_of_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2.1069062851319544</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;state&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;VA&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2467</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;state_as_percent_of_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1.9952928235779395</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;state&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;MI&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2340</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;state_as_percent_of_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1.8925760872202588</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;state&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;KS&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2192</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;state_as_percent_of_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1.7728746936695756</span></span>
<span class="line"><span style="color: #000000">  }</span></span>
<span class="line"><span style="color: #000000">]</span></span></pre></pre>
      </div>
    </div>
    <div class="result-middle" data-result-kind="sql" >
      <div class="result-inner">
        <pre><pre class="language-sql" style="background-color: #FBFBFB"><span class="line"><span style="color: #0000FF">WITH</span><span style="color: #000000"> __stage0 </span><span style="color: #0000FF">AS</span><span style="color: #000000"> (</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">SELECT</span></span>
<span class="line"><span style="color: #000000">    group_set,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">0</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COALESCE</span><span style="color: #000000">(</span><span style="color: #795E26">SUM</span><span style="color: #000000">(base.number),</span><span style="color: #098658">0</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> total_population__0,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      base.state</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> state__1,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COALESCE</span><span style="color: #000000">(</span><span style="color: #795E26">SUM</span><span style="color: #000000">(base.number),</span><span style="color: #098658">0</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> total_population__1</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">FROM</span><span style="color: #000000"> </span><span style="color: #A31515">`bigquery-public-data.usa_names.usa_1910_2013`</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> base</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">CROSS</span><span style="color: #000000"> </span><span style="color: #0000FF">JOIN</span><span style="color: #000000"> (</span><span style="color: #0000FF">SELECT</span><span style="color: #000000"> </span><span style="color: #795E26">row_number</span><span style="color: #000000">() </span><span style="color: #0000FF">OVER</span><span style="color: #000000">() -</span><span style="color: #098658">1</span><span style="color: #000000">  group_set </span><span style="color: #0000FF">FROM</span><span style="color: #000000"> UNNEST(GENERATE_ARRAY(</span><span style="color: #098658">0</span><span style="color: #000000">,</span><span style="color: #098658">1</span><span style="color: #000000">,</span><span style="color: #098658">1</span><span style="color: #000000">)))</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">WHERE</span><span style="color: #000000"> base.name=</span><span style="color: #A31515">&#39;Billie&#39;</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">GROUP BY</span><span style="color: #000000"> </span><span style="color: #098658">1</span><span style="color: #000000">,</span><span style="color: #098658">3</span></span>
<span class="line"><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">, __stage1 </span><span style="color: #0000FF">AS</span><span style="color: #000000"> (</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">SELECT</span></span>
<span class="line"><span style="color: #000000">    ANY_VALUE(</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">0</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> total_population__0 </span><span style="color: #0000FF">END</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> total_population,</span></span>
<span class="line"><span style="color: #000000">    ARRAY_AGG(</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> STRUCT(</span></span>
<span class="line"><span style="color: #000000">      state__1 </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #0000FF">state</span><span style="color: #000000">, </span></span>
<span class="line"><span style="color: #000000">      total_population__1 </span><span style="color: #0000FF">as</span><span style="color: #000000"> total_population</span></span>
<span class="line"><span style="color: #000000">      ) </span><span style="color: #0000FF">END</span><span style="color: #000000"> IGNORE NULLS  </span><span style="color: #0000FF">ORDER BY</span><span style="color: #000000">  total_population__1 </span><span style="color: #0000FF">desc</span><span style="color: #000000"> ) </span><span style="color: #0000FF">as</span><span style="color: #000000"> main_query</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">FROM</span><span style="color: #000000"> __stage0</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">ORDER BY</span><span style="color: #000000"> </span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">desc</span></span>
<span class="line"><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #0000FF">SELECT</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">   main_query_0.state </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #0000FF">state</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">   main_query_0.total_population </span><span style="color: #0000FF">as</span><span style="color: #000000"> total_population,</span></span>
<span class="line"><span style="color: #000000">   (main_query_0.total_population/base.total_population)*</span><span style="color: #098658">100</span><span style="color: #000000">.</span><span style="color: #098658">0</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> state_as_percent_of_population</span></span>
<span class="line"><span style="color: #0000FF">FROM</span><span style="color: #000000"> __stage1 </span><span style="color: #0000FF">as</span><span style="color: #000000"> base</span></span>
<span class="line"><span style="color: #0000FF">LEFT JOIN</span><span style="color: #000000"> UNNEST(base.main_query) </span><span style="color: #0000FF">as</span><span style="color: #000000"> main_query_0</span></span>
<span class="line"><span style="color: #0000FF">ORDER BY</span><span style="color: #000000"> </span><span style="color: #098658">3</span><span style="color: #000000"> </span><span style="color: #0000FF">desc</span></span>
<span class="line"></span></pre></pre>
      </div>
    </div>
  </div><p>We could run this same query, but instead look by decade to see when the Billies where born.
Using the query below we can see that 26% of all Billies were born in the 1930s.</p>
<pre class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #AF00DB">query</span><span style="color: #000000">: </span><span style="color: #795E26">table</span><span style="color: #000000">(</span><span style="color: #A31515">&#39;bigquery-public-data.usa_names.usa_1910_2013&#39;</span><span style="color: #000000">) -&gt; {</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">where</span><span style="color: #000000">: </span><span style="color: #001080">name</span><span style="color: #000000"> = </span><span style="color: #A31515">&#39;Billie&#39;</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">aggregate</span><span style="color: #000000">: </span><span style="color: #001080">total_population</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #001080">`number`</span><span style="color: #000000">.</span><span style="color: #795E26">sum</span><span style="color: #000000">()</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">nest</span><span style="color: #000000">: </span><span style="color: #001080">main_query</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #AF00DB">group_by</span><span style="color: #000000">: </span><span style="color: #001080">decade</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #795E26">floor</span><span style="color: #000000">(</span><span style="color: #001080">`year`</span><span style="color: #000000"> / </span><span style="color: #098658">10</span><span style="color: #000000">) * </span><span style="color: #098658">10</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #AF00DB">aggregate</span><span style="color: #000000">: </span><span style="color: #001080">total_population</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #001080">`number`</span><span style="color: #000000">.</span><span style="color: #795E26">sum</span><span style="color: #000000">()</span></span>
<span class="line"><span style="color: #000000">  }</span></span>
<span class="line"><span style="color: #000000">} -&gt; {</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">project</span><span style="color: #000000">:</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #001080">main_query</span><span style="color: #000000">.</span><span style="color: #001080">decade</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #001080">main_query</span><span style="color: #000000">.</span><span style="color: #001080">total_population</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #001080">decade_as_percent_of_population</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #001080">main_query</span><span style="color: #000000">.</span><span style="color: #001080">total_population</span><span style="color: #000000"> / </span><span style="color: #001080">total_population</span><span style="color: #000000"> * </span><span style="color: #098658">100.0</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">order_by</span><span style="color: #000000">: </span><span style="color: #001080">decade_as_percent_of_population</span><span style="color: #000000"> </span><span style="color: #AF00DB">desc</span></span>
<span class="line"><span style="color: #000000">}</span></span></pre><div class="result-outer small">
    <div class="result-controls-bar">
      <span class="result-label">QUERY RESULTS</span>
      <div class="result-controls">
        <button class="result-control"  data-result-kind="html">HTML</button>
        <button class="result-control" selected data-result-kind="json">JSON</button>
        <button class="result-control"  data-result-kind="sql">SQL</button>
      </div>
    </div>
    <div class="result-middle" data-result-kind="html" >
      <div class="result-inner">
        <table style="vertical-align: top; border-collapse: collapse; width: 100%;"><thead><tr><th style="padding: 8px; text-align: right;">decade</th><th style="padding: 8px; text-align: right;">total_​population</th><th style="padding: 8px; text-align: right;">decade_​as_​percent_​of_​population</th></tr></thead><tbody><tr><td style="padding: 8px; vertical-align: top; text-align: right;"><span>1,930</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>32,560</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>26.334</span></td></tr><tr><td style="padding: 8px; vertical-align: top; text-align: right;"><span>1,920</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>27,559</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>22.29</span></td></tr><tr><td style="padding: 8px; vertical-align: top; text-align: right;"><span>1,940</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>19,616</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>15.865</span></td></tr><tr><td style="padding: 8px; vertical-align: top; text-align: right;"><span>1,950</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>13,185</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>10.664</span></td></tr><tr><td style="padding: 8px; vertical-align: top; text-align: right;"><span>1,970</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>10,469</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>8.467</span></td></tr><tr><td style="padding: 8px; vertical-align: top; text-align: right;"><span>1,960</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>8,556</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>6.92</span></td></tr><tr><td style="padding: 8px; vertical-align: top; text-align: right;"><span>1,910</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>5,349</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>4.326</span></td></tr><tr><td style="padding: 8px; vertical-align: top; text-align: right;"><span>1,980</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>4,091</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>3.309</span></td></tr><tr><td style="padding: 8px; vertical-align: top; text-align: right;"><span>1,990</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>1,646</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>1.331</span></td></tr><tr><td style="padding: 8px; vertical-align: top; text-align: right;"><span>2,000</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>456</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>0.369</span></td></tr><tr><td style="padding: 8px; vertical-align: top; text-align: right;"><span>2,010</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>154</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>0.125</span></td></tr></tbody></table>
      </div>
    </div>
    <div class="result-middle" data-result-kind="json" selected>
      <div class="result-inner">
        <pre><pre class="language-json" style="background-color: #FBFBFB"><span class="line"><span style="color: #000000">[</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;decade&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1930</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">32560</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;decade_as_percent_of_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">26.334306581150262</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;decade&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1920</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">27559</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;decade_as_percent_of_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">22.289531789616714</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;decade&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1940</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">19616</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;decade_as_percent_of_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">15.865287404663503</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;decade&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1950</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">13185</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;decade_as_percent_of_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">10.663938337606456</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;decade&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1970</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">10469</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;decade_as_percent_of_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">8.46725600731149</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;decade&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1960</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">8556</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;decade_as_percent_of_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">6.9200346163489455</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;decade&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1910</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">5349</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;decade_as_percent_of_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">4.3262348250175915</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;decade&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1980</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">4091</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;decade_as_percent_of_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">3.3087729798367853</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;decade&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1990</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1646</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;decade_as_percent_of_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1.3312736066515154</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;decade&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2000</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">456</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;decade_as_percent_of_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.3688096990480504</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;decade&quot;</span><span style="color: #000000">: </span><span style="color: #098658">2010</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">154</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;decade_as_percent_of_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">0.1245541527486837</span></span>
<span class="line"><span style="color: #000000">  }</span></span>
<span class="line"><span style="color: #000000">]</span></span></pre></pre>
      </div>
    </div>
    <div class="result-middle" data-result-kind="sql" >
      <div class="result-inner">
        <pre><pre class="language-sql" style="background-color: #FBFBFB"><span class="line"><span style="color: #0000FF">WITH</span><span style="color: #000000"> __stage0 </span><span style="color: #0000FF">AS</span><span style="color: #000000"> (</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">SELECT</span></span>
<span class="line"><span style="color: #000000">    group_set,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">0</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COALESCE</span><span style="color: #000000">(</span><span style="color: #795E26">SUM</span><span style="color: #000000">(base.number),</span><span style="color: #098658">0</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> total_population__0,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      (</span><span style="color: #795E26">floor</span><span style="color: #000000">(base.year/</span><span style="color: #098658">10</span><span style="color: #000000">))*</span><span style="color: #098658">10</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> decade__1,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COALESCE</span><span style="color: #000000">(</span><span style="color: #795E26">SUM</span><span style="color: #000000">(base.number),</span><span style="color: #098658">0</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> total_population__1</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">FROM</span><span style="color: #000000"> </span><span style="color: #A31515">`bigquery-public-data.usa_names.usa_1910_2013`</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> base</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">CROSS</span><span style="color: #000000"> </span><span style="color: #0000FF">JOIN</span><span style="color: #000000"> (</span><span style="color: #0000FF">SELECT</span><span style="color: #000000"> </span><span style="color: #795E26">row_number</span><span style="color: #000000">() </span><span style="color: #0000FF">OVER</span><span style="color: #000000">() -</span><span style="color: #098658">1</span><span style="color: #000000">  group_set </span><span style="color: #0000FF">FROM</span><span style="color: #000000"> UNNEST(GENERATE_ARRAY(</span><span style="color: #098658">0</span><span style="color: #000000">,</span><span style="color: #098658">1</span><span style="color: #000000">,</span><span style="color: #098658">1</span><span style="color: #000000">)))</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">WHERE</span><span style="color: #000000"> base.name=</span><span style="color: #A31515">&#39;Billie&#39;</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">GROUP BY</span><span style="color: #000000"> </span><span style="color: #098658">1</span><span style="color: #000000">,</span><span style="color: #098658">3</span></span>
<span class="line"><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">, __stage1 </span><span style="color: #0000FF">AS</span><span style="color: #000000"> (</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">SELECT</span></span>
<span class="line"><span style="color: #000000">    ANY_VALUE(</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">0</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> total_population__0 </span><span style="color: #0000FF">END</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> total_population,</span></span>
<span class="line"><span style="color: #000000">    ARRAY_AGG(</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> STRUCT(</span></span>
<span class="line"><span style="color: #000000">      decade__1 </span><span style="color: #0000FF">as</span><span style="color: #000000"> decade, </span></span>
<span class="line"><span style="color: #000000">      total_population__1 </span><span style="color: #0000FF">as</span><span style="color: #000000"> total_population</span></span>
<span class="line"><span style="color: #000000">      ) </span><span style="color: #0000FF">END</span><span style="color: #000000"> IGNORE NULLS  </span><span style="color: #0000FF">ORDER BY</span><span style="color: #000000">  total_population__1 </span><span style="color: #0000FF">desc</span><span style="color: #000000"> ) </span><span style="color: #0000FF">as</span><span style="color: #000000"> main_query</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">FROM</span><span style="color: #000000"> __stage0</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">ORDER BY</span><span style="color: #000000"> </span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">desc</span></span>
<span class="line"><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #0000FF">SELECT</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">   main_query_0.decade </span><span style="color: #0000FF">as</span><span style="color: #000000"> decade,</span></span>
<span class="line"><span style="color: #000000">   main_query_0.total_population </span><span style="color: #0000FF">as</span><span style="color: #000000"> total_population,</span></span>
<span class="line"><span style="color: #000000">   (main_query_0.total_population/base.total_population)*</span><span style="color: #098658">100</span><span style="color: #000000">.</span><span style="color: #098658">0</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> decade_as_percent_of_population</span></span>
<span class="line"><span style="color: #0000FF">FROM</span><span style="color: #000000"> __stage1 </span><span style="color: #0000FF">as</span><span style="color: #000000"> base</span></span>
<span class="line"><span style="color: #0000FF">LEFT JOIN</span><span style="color: #000000"> UNNEST(base.main_query) </span><span style="color: #0000FF">as</span><span style="color: #000000"> main_query_0</span></span>
<span class="line"><span style="color: #0000FF">ORDER BY</span><span style="color: #000000"> </span><span style="color: #098658">3</span><span style="color: #000000"> </span><span style="color: #0000FF">desc</span></span>
<span class="line"></span></pre></pre>
      </div>
    </div>
  </div>
      <h2>
        <a id="names-as-cohorts" class="header-link anchor" href="#names-as-cohorts">
          Names as Cohorts
        </a>
      </h2>
    <p>In the above example, the population was <em>People named Billie</em> and we used <em>state</em> or <em>year</em> for our cohort (grouping).
Lets flip it around and look at people born with a particular name as a cohort and the other attributes to limit our population.
Let's limit our population to California in 1990 and look at the most cohorts (people with a given name).  We are also going
to measure a little differently.  Instead of looking at a percentage, let's look at births per 100,000 people.</p>
<pre class="language-malloy" style="background-color: #FBFBFB"><span class="line"><span style="color: #AF00DB">query</span><span style="color: #000000">: </span><span style="color: #795E26">table</span><span style="color: #000000">(</span><span style="color: #A31515">&#39;bigquery-public-data.usa_names.usa_1910_2013&#39;</span><span style="color: #000000">) -&gt; {</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">where</span><span style="color: #000000">: </span><span style="color: #001080">state</span><span style="color: #000000"> = </span><span style="color: #A31515">&#39;CA&#39;</span><span style="color: #000000"> </span><span style="color: #0000FF">and</span><span style="color: #000000"> </span><span style="color: #001080">`year`</span><span style="color: #000000"> = </span><span style="color: #098658">1990</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">aggregate</span><span style="color: #000000">: </span><span style="color: #001080">total_population</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #001080">`number`</span><span style="color: #000000">.</span><span style="color: #795E26">sum</span><span style="color: #000000">()</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">nest</span><span style="color: #000000">: </span><span style="color: #001080">main_query</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #AF00DB">group_by</span><span style="color: #000000">: </span><span style="color: #001080">name</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #AF00DB">aggregate</span><span style="color: #000000">: </span><span style="color: #001080">total_population</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #001080">`number`</span><span style="color: #000000">.</span><span style="color: #795E26">sum</span><span style="color: #000000">()</span></span>
<span class="line"><span style="color: #000000">  }</span></span>
<span class="line"><span style="color: #000000">} -&gt; {</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">project</span><span style="color: #000000">:</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #001080">main_query</span><span style="color: #000000">.</span><span style="color: #001080">name</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #001080">main_query</span><span style="color: #000000">.</span><span style="color: #001080">total_population</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #001080">births_per_100k</span><span style="color: #000000"> </span><span style="color: #AF00DB">is</span><span style="color: #000000"> </span><span style="color: #795E26">FLOOR</span><span style="color: #000000">(</span><span style="color: #001080">main_query</span><span style="color: #000000">.</span><span style="color: #001080">total_population</span><span style="color: #000000"> / </span><span style="color: #001080">total_population</span><span style="color: #000000"> * </span><span style="color: #098658">100000.0</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #AF00DB">order_by</span><span style="color: #000000">: </span><span style="color: #001080">births_per_100k</span><span style="color: #000000"> </span><span style="color: #AF00DB">desc</span></span>
<span class="line"><span style="color: #000000">}</span></span></pre><div class="result-outer small">
    <div class="result-controls-bar">
      <span class="result-label">QUERY RESULTS</span>
      <div class="result-controls">
        <button class="result-control"  data-result-kind="html">HTML</button>
        <button class="result-control" selected data-result-kind="json">JSON</button>
        <button class="result-control"  data-result-kind="sql">SQL</button>
      </div>
    </div>
    <div class="result-middle" data-result-kind="html" >
      <div class="result-inner">
        <table style="vertical-align: top; border-collapse: collapse; width: 100%;"><thead><tr><th style="padding: 8px; text-align: left;">name</th><th style="padding: 8px; text-align: right;">total_​population</th><th style="padding: 8px; text-align: right;">births_​per_​100k</th></tr></thead><tbody><tr><td style="padding: 8px; vertical-align: top;"><span>Michael</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>8,306</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>1,504</span></td></tr><tr><td style="padding: 8px; vertical-align: top;"><span>Jessica</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>6,667</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>1,207</span></td></tr><tr><td style="padding: 8px; vertical-align: top;"><span>Christopher</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>6,665</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>1,207</span></td></tr><tr><td style="padding: 8px; vertical-align: top;"><span>Daniel</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>5,812</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>1,052</span></td></tr><tr><td style="padding: 8px; vertical-align: top;"><span>David</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>5,384</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>975</span></td></tr><tr><td style="padding: 8px; vertical-align: top;"><span>Jose</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>4,971</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>900</span></td></tr><tr><td style="padding: 8px; vertical-align: top;"><span>Matthew</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>4,914</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>889</span></td></tr><tr><td style="padding: 8px; vertical-align: top;"><span>Andrew</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>4,576</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>828</span></td></tr><tr><td style="padding: 8px; vertical-align: top;"><span>Ashley</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>4,565</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>826</span></td></tr><tr><td style="padding: 8px; vertical-align: top;"><span>Joshua</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>4,329</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>783</span></td></tr><tr><td style="padding: 8px; vertical-align: top;"><span>Jonathan</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>4,137</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>749</span></td></tr><tr><td style="padding: 8px; vertical-align: top;"><span>Anthony</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>4,047</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>732</span></td></tr><tr><td style="padding: 8px; vertical-align: top;"><span>Stephanie</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>4,029</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>729</span></td></tr><tr><td style="padding: 8px; vertical-align: top;"><span>Amanda</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>3,868</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>700</span></td></tr><tr><td style="padding: 8px; vertical-align: top;"><span>Ryan</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>3,686</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>667</span></td></tr><tr><td style="padding: 8px; vertical-align: top;"><span>Jennifer</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>3,634</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>658</span></td></tr><tr><td style="padding: 8px; vertical-align: top;"><span>Robert</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>3,618</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>655</span></td></tr><tr><td style="padding: 8px; vertical-align: top;"><span>Joseph</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>3,595</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>651</span></td></tr><tr><td style="padding: 8px; vertical-align: top;"><span>Nicholas</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>3,481</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>630</span></td></tr><tr><td style="padding: 8px; vertical-align: top;"><span>Kevin</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>3,334</span></td><td style="padding: 8px; vertical-align: top; text-align: right;"><span>603</span></td></tr></tbody></table>
      </div>
    </div>
    <div class="result-middle" data-result-kind="json" selected>
      <div class="result-inner">
        <pre><pre class="language-json" style="background-color: #FBFBFB"><span class="line"><span style="color: #000000">[</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;name&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;Michael&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">8306</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;births_per_100k&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1504</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;name&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;Jessica&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">6667</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;births_per_100k&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1207</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;name&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;Christopher&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">6665</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;births_per_100k&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1207</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;name&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;Daniel&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">5812</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;births_per_100k&quot;</span><span style="color: #000000">: </span><span style="color: #098658">1052</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;name&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;David&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">5384</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;births_per_100k&quot;</span><span style="color: #000000">: </span><span style="color: #098658">975</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;name&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;Jose&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">4971</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;births_per_100k&quot;</span><span style="color: #000000">: </span><span style="color: #098658">900</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;name&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;Matthew&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">4914</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;births_per_100k&quot;</span><span style="color: #000000">: </span><span style="color: #098658">889</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;name&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;Andrew&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">4576</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;births_per_100k&quot;</span><span style="color: #000000">: </span><span style="color: #098658">828</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;name&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;Ashley&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">4565</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;births_per_100k&quot;</span><span style="color: #000000">: </span><span style="color: #098658">826</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;name&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;Joshua&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">4329</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;births_per_100k&quot;</span><span style="color: #000000">: </span><span style="color: #098658">783</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;name&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;Jonathan&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">4137</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;births_per_100k&quot;</span><span style="color: #000000">: </span><span style="color: #098658">749</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;name&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;Anthony&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">4047</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;births_per_100k&quot;</span><span style="color: #000000">: </span><span style="color: #098658">732</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;name&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;Stephanie&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">4029</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;births_per_100k&quot;</span><span style="color: #000000">: </span><span style="color: #098658">729</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;name&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;Amanda&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">3868</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;births_per_100k&quot;</span><span style="color: #000000">: </span><span style="color: #098658">700</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;name&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;Ryan&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">3686</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;births_per_100k&quot;</span><span style="color: #000000">: </span><span style="color: #098658">667</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;name&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;Jennifer&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">3634</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;births_per_100k&quot;</span><span style="color: #000000">: </span><span style="color: #098658">658</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;name&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;Robert&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">3618</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;births_per_100k&quot;</span><span style="color: #000000">: </span><span style="color: #098658">655</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;name&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;Joseph&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">3595</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;births_per_100k&quot;</span><span style="color: #000000">: </span><span style="color: #098658">651</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;name&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;Nicholas&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">3481</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;births_per_100k&quot;</span><span style="color: #000000">: </span><span style="color: #098658">630</span></span>
<span class="line"><span style="color: #000000">  },</span></span>
<span class="line"><span style="color: #000000">  {</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;name&quot;</span><span style="color: #000000">: </span><span style="color: #A31515">&quot;Kevin&quot;</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;total_population&quot;</span><span style="color: #000000">: </span><span style="color: #098658">3334</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0451A5">&quot;births_per_100k&quot;</span><span style="color: #000000">: </span><span style="color: #098658">603</span></span>
<span class="line"><span style="color: #000000">  }</span></span>
<span class="line"><span style="color: #000000">]</span></span></pre></pre>
      </div>
    </div>
    <div class="result-middle" data-result-kind="sql" >
      <div class="result-inner">
        <pre><pre class="language-sql" style="background-color: #FBFBFB"><span class="line"><span style="color: #0000FF">WITH</span><span style="color: #000000"> __stage0 </span><span style="color: #0000FF">AS</span><span style="color: #000000"> (</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">SELECT</span></span>
<span class="line"><span style="color: #000000">    group_set,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">0</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COALESCE</span><span style="color: #000000">(</span><span style="color: #795E26">SUM</span><span style="color: #000000">(base.number),</span><span style="color: #098658">0</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> total_population__0,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      base.name</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> name__1,</span></span>
<span class="line"><span style="color: #000000">    </span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #795E26">COALESCE</span><span style="color: #000000">(</span><span style="color: #795E26">SUM</span><span style="color: #000000">(base.number),</span><span style="color: #098658">0</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">      </span><span style="color: #0000FF">END</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> total_population__1</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">FROM</span><span style="color: #000000"> </span><span style="color: #A31515">`bigquery-public-data.usa_names.usa_1910_2013`</span><span style="color: #000000"> </span><span style="color: #0000FF">as</span><span style="color: #000000"> base</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">CROSS</span><span style="color: #000000"> </span><span style="color: #0000FF">JOIN</span><span style="color: #000000"> (</span><span style="color: #0000FF">SELECT</span><span style="color: #000000"> </span><span style="color: #795E26">row_number</span><span style="color: #000000">() </span><span style="color: #0000FF">OVER</span><span style="color: #000000">() -</span><span style="color: #098658">1</span><span style="color: #000000">  group_set </span><span style="color: #0000FF">FROM</span><span style="color: #000000"> UNNEST(GENERATE_ARRAY(</span><span style="color: #098658">0</span><span style="color: #000000">,</span><span style="color: #098658">1</span><span style="color: #000000">,</span><span style="color: #098658">1</span><span style="color: #000000">)))</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">WHERE</span><span style="color: #000000"> (base.state=</span><span style="color: #A31515">&#39;CA&#39;</span><span style="color: #000000">)</span><span style="color: #0000FF">and</span><span style="color: #000000">(base.year=</span><span style="color: #098658">1990</span><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">GROUP BY</span><span style="color: #000000"> </span><span style="color: #098658">1</span><span style="color: #000000">,</span><span style="color: #098658">3</span></span>
<span class="line"><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #000000">, __stage1 </span><span style="color: #0000FF">AS</span><span style="color: #000000"> (</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">SELECT</span></span>
<span class="line"><span style="color: #000000">    ANY_VALUE(</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">0</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> total_population__0 </span><span style="color: #0000FF">END</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> total_population,</span></span>
<span class="line"><span style="color: #000000">    ARRAY_AGG(</span><span style="color: #0000FF">CASE</span><span style="color: #000000"> </span><span style="color: #0000FF">WHEN</span><span style="color: #000000"> group_set=</span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">THEN</span><span style="color: #000000"> STRUCT(</span></span>
<span class="line"><span style="color: #000000">      name__1 </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #0000FF">name</span><span style="color: #000000">, </span></span>
<span class="line"><span style="color: #000000">      total_population__1 </span><span style="color: #0000FF">as</span><span style="color: #000000"> total_population</span></span>
<span class="line"><span style="color: #000000">      ) </span><span style="color: #0000FF">END</span><span style="color: #000000"> IGNORE NULLS  </span><span style="color: #0000FF">ORDER BY</span><span style="color: #000000">  total_population__1 </span><span style="color: #0000FF">desc</span><span style="color: #000000"> ) </span><span style="color: #0000FF">as</span><span style="color: #000000"> main_query</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">FROM</span><span style="color: #000000"> __stage0</span></span>
<span class="line"><span style="color: #000000">  </span><span style="color: #0000FF">ORDER BY</span><span style="color: #000000"> </span><span style="color: #098658">1</span><span style="color: #000000"> </span><span style="color: #0000FF">desc</span></span>
<span class="line"><span style="color: #000000">)</span></span>
<span class="line"><span style="color: #0000FF">SELECT</span><span style="color: #000000"> </span></span>
<span class="line"><span style="color: #000000">   main_query_0.name </span><span style="color: #0000FF">as</span><span style="color: #000000"> </span><span style="color: #0000FF">name</span><span style="color: #000000">,</span></span>
<span class="line"><span style="color: #000000">   main_query_0.total_population </span><span style="color: #0000FF">as</span><span style="color: #000000"> total_population,</span></span>
<span class="line"><span style="color: #000000">   </span><span style="color: #795E26">FLOOR</span><span style="color: #000000">((main_query_0.total_population/base.total_population)*</span><span style="color: #098658">100000</span><span style="color: #000000">.</span><span style="color: #098658">0</span><span style="color: #000000">) </span><span style="color: #0000FF">as</span><span style="color: #000000"> births_per_100k</span></span>
<span class="line"><span style="color: #0000FF">FROM</span><span style="color: #000000"> __stage1 </span><span style="color: #0000FF">as</span><span style="color: #000000"> base</span></span>
<span class="line"><span style="color: #0000FF">LEFT JOIN</span><span style="color: #000000"> UNNEST(base.main_query) </span><span style="color: #0000FF">as</span><span style="color: #000000"> main_query_0</span></span>
<span class="line"><span style="color: #0000FF">ORDER BY</span><span style="color: #000000"> </span><span style="color: #098658">3</span><span style="color: #000000"> </span><span style="color: #0000FF">desc</span></span>
<span class="line"></span></pre></pre>
      </div>
    </div>
  </div></div>
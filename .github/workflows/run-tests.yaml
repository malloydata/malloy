name: Run Malloy Tests

on: [workflow_dispatch, pull_request]

jobs:
  test-all:
    uses: './.github/workflows/main.yaml'
    secrets:
      BIGQUERY_KEY: ${{ secrets.BIGQUERY_KEY }}
  test-trino:
    uses: './.github/workflows/db-trino.yaml'
    secrets:
      BQ_PRESTO_TRINO_KEY: ${{ secrets.BQ_PRESTO_TRINO_KEY }}
  test-presto:
    uses: './.github/workflows/db-presto.yaml'
    secrets:
      BQ_PRESTO_TRINO_KEY: ${{ secrets.BQ_PRESTO_TRINO_KEY }}
  test-duckdb:
    uses: './.github/workflows/db-duckdb.yaml'
  test-bigquery:
    uses: './.github/workflows/db-bigquery.yaml'
    secrets:
      BIGQUERY_KEY: ${{ secrets.BIGQUERY_KEY }}
  test-motherduck:
    uses: './.github/workflows/db-motherduck.yaml'
    secrets:
      MOTHERDUCK_TOKEN_10: ${{ secrets.MOTHERDUCK_TOKEN_10 }}
  test-postgres:
    uses: './.github/workflows/db-postgres.yaml'
  test-snowflake:
    uses: './.github/workflows/db-snowflake.yaml'
    secrets:
      SNOWFLAKE_CONNECTION: ${{ secrets.SNOWFLAKE_CONNECTION }}
  test-mysql:
    uses: './.github/workflows/db-mysql.yaml'
  test-duckdb-wasm:
    uses: './.github/workflows/db-duckdb-wasm.yaml'

  # I think I have the sorted roughly longest to shortest
  # so the longer running jobs get workers sooner, not sure
  # that is the right plan
  malloy-tests:
    needs:
      - test-all
      - test-snowflake
      - test-bigquery
      - test-duckdb
      - test-presto
      - test-duckdb-wasm
      - test-trino
      - test-postgres
      - test-motherduck
      - test-mysql
    runs-on: ubuntu-latest
    steps:
      - name: Success
        run: echo Success

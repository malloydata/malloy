# Malloy Renderer Tag Documentation

This document outlines the tags used to control visualizations generated by the custom Malloy renderer. Add these tags as annotations to your Malloy queries (`.malloy` files) to influence how the resulting data is displayed.

**Basic Syntax:**

- Tags are prefixed with `#` followed by a space: `# tag_name` (e.g., `# currency`)
- Tags with properties: `# tag_name { property1=value property2 ... }` (e.g., `# bar_chart { size=lg stack }`)
- Boolean properties can often be added using dot notation: `# tag_name.property` (e.g., `# bar_chart.stack`)
- Nested properties can target specific aspects: `# bar_chart { y.independent }`

---

## Chart Tags

These tags render the entire result set as a specific chart type.

### `# bar_chart`

Renders the data as a bar chart. If `x`, `y`, and `series` fields aren't explicitly specified via tags, the renderer attempts to infer them from the query structure (typically first dimension for x, first measure for y, second dimension for series).

**Properties:**

- `.stack`: Stacks bars when a series is present.
  - Syntax: `# bar_chart.stack` or `# bar_chart { stack }`
- `.size`: Controls chart size presets.
  - Values: `spark`, `xs`, `sm`, `md`, `lg`, `xl`, `2xl`.
  - Syntax: `# bar_chart { size=lg }` or `# bar_chart.size=lg` (Legacy: `# size=lg` on the view)
- `.size.width`: Sets a specific pixel width for the chart plot area.
  - Syntax: `# bar_chart { size.width=300 }`
- `.size.height`: Sets a specific pixel height for the chart plot area.
  - Syntax: `# bar_chart { size.height=220 }`
- `.x`: Specifies the field for the x-axis (category axis).
  - Syntax: `# bar_chart { x=field_name }`
  - `.x.limit`: Limits the number of bars shown on the x-axis. Automatically calculated based on chart width if not specified.
    - Syntax: `# bar_chart { x.limit=10 }`
  - `.x.independent`: Controls whether the x-axis scale is shared across nested charts. See "Automatic Axis/Legend Sharing" below.
    - Syntax: `# bar_chart { x.independent }` or `# bar_chart { x.independent=false }`
- `.y`: Specifies the field(s) for the y-axis (value axis). Can be a single field name or an array for measure-based series.
  - Syntax: `# bar_chart { y=measure_name }` or `# bar_chart { y=['measure1', 'measure2'] }`
  - `.y.independent`: Controls whether the y-axis scale is shared across nested charts (default is shared).
    - Syntax: `# bar_chart { y.independent }`
- `.series`: Specifies the field used for grouping/coloring bars.
  - Syntax: `# bar_chart { series=dimension_name }`
  - `.series.limit`: Limits the number of series shown (default `auto`, which uses 20 for bar charts). When limiting is active, series are ranked by their total sum of Y-values and the top N series are shown.
    - Syntax: `# bar_chart { series.limit=5 }` or `# bar_chart { series.limit=auto }`
  - `.series.independent`: Controls whether the series legend/colors are shared across nested charts. See "Automatic Axis/Legend Sharing" below.
    - Syntax: `# bar_chart { series.independent }` or `# bar_chart { series.independent=false }`
- `.title`: Sets the main title for the chart.
  - Syntax: `# bar_chart { title='My Chart Title' }`
- `.subtitle`: Sets a subtitle displayed below the title.
  - Syntax: `# bar_chart { subtitle='Data for Q1' }`

**Automatic Axis/Legend Sharing (Bar Chart):**

- **X-Axis:** By default, the x-axis domain (the set of categories shown) is shared across nested charts _if_ the number of distinct x-values is small (currently <= 20). This keeps alignment consistent for comparable small multiples. If there are more than 20 distinct values, each nested chart gets its own independent x-axis domain.
- **Series Legend/Colors:** Similarly, the series domain (legend items and colors) is shared across nested charts if the number of distinct series values is small (currently <= 20).
- **Overriding:** You can force sharing by using `.independent=false` (e.g., `# bar_chart { x.independent=false }`) or force independence by using `.independent` or `.independent=true` (e.g., `# bar_chart { series.independent }`).
- **Y-Axis:** The y-axis is shared by default unless explicitly set via `# bar_chart { y.independent }`.

**Examples:**

```
// Simple bar chart, axes inferred
# bar_chart
view: my_bars is {
  group_by: category
  aggregate: total_sales
  limit: 10
}

// Stacked bar chart with explicit axes and size
# bar_chart { stack x=sale_month series=category y=total_sales size=lg }
view: sales_by_month is { ... }

// Measure-based series
# bar_chart { x=brand y=['Sales $', 'Cost $'] }
view: sales_vs_cost is { ... }

// Independent Y-axis in a nested chart
view: parent_view is {
group_by: region
nest: by_brand is {
# bar_chart { y.independent title='Sales by Brand' }
group_by: brand
aggregate: total_sales
limit: 5
}
}
```

### `# line_chart`

Renders the data as a line chart. Inference for `x`, `y`, and `series` is similar to `# bar_chart`.

**Properties:**

- `.zero_baseline`: Controls if the y-axis must include zero. Default is `false` for line charts (unlike bar charts which always include zero). Set to `true` to force the y-axis to start at zero.
  - Syntax: `# line_chart.zero_baseline=true` or `# line_chart { zero_baseline=true }`
- `.size`: Controls chart size presets (e.g., `spark`).
  - Syntax: `# line_chart { size=spark }` (Legacy: `# size=spark` on the view)
- `.interpolate`: Sets the line interpolation mode.
  - Values: e.g., `step`.
  - Syntax: `# line_chart { interpolate=step }`
- `.x`, `.y`, `.series`, `.title`, `.subtitle`: Similar to `# bar_chart` properties.
  - `.y.independent`: Controls y-axis independence across nested charts. Also automatically set if `series.limit` is applied.
  - `.series.limit`: Limits the number of lines (series) shown (default `auto`, which uses 12 for line charts). When limiting is active, series are ranked by their total sum of Y-values and the top N series are shown. Setting this automatically enables `y.independent=true`.
  - `.series.independent`: Controls legend/color sharing across nested charts. See "Automatic Axis/Legend Sharing" below.

**Automatic Axis/Legend Sharing (Line Chart):**

- **X-Axis:** Similar to bar charts, the x-axis domain is shared by default if distinct x-values <= 20, otherwise independent.
- **Series Legend/Colors:** Shared by default if distinct series values <= 20, otherwise independent.
- **Overriding:** Use `.independent=false` to force sharing or `.independent` / `.independent=true` to force independence (e.g., `# line_chart { x.independent }`, `# line_chart { series.independent=false }`).
- **Y-Axis:** Shared by default unless explicitly set via `# line_chart { y.independent }` or if `.series.limit` is used.

**Examples:**

```
// Basic line chart
# line_chart
view: sales_trend is {
  group_by: sale_date.month
  aggregate: total_sales
}

// Line chart with y-axis not starting at zero
# line_chart { zero_baseline=false }
view: stock_price is { ... }

// Multi-series line chart with limited series (implies y.independent)
# line_chart { series.limit=5 }
view: multi_brand_trend is {
group_by: sale_date.day, brand
aggregate: daily_sales
}
```

### `# scatter_chart`

_Note: This currently uses the legacy renderer._
Renders the data as a scatter plot. Configuration relies mainly on field order (x, y, color, size, shape).

**Properties:**

- _(No specific nested properties identified in the current codebase examples for configuration via the tag itself, likely relies on field order/type)_

**Example:**

```
# scatter_chart
view: cost_vs_price is {
  group_by: retail_price, cost, brand // x, y, color/shape inferred
}
```

---

## Data Limiting and Performance

Both bar charts and line charts implement automatic data limiting to ensure good performance and readability. Understanding these limits helps you configure charts effectively.

### Series Limiting

**Default Limits:**
- **Line Charts:** 12 series (when `series.limit=auto`)
- **Bar Charts:** 20 series (when `series.limit=auto`)

**How Series Are Selected:**
When the number of unique series values exceeds the limit, the renderer:
1. Calculates the total sum of Y-values for each series
2. Ranks series by their total sum (highest to lowest)
3. Shows only the top N series based on the limit
4. Displays a message like "Showing 12 of 45 series"

**Automatic Y-Axis Independence:**
When series limiting is active, the renderer automatically sets `y.independent=true` to prevent misleading comparisons between charts that may be showing different subsets of series.

### Data Point Limiting

**Line Charts:**
- Maximum of 5,000 data points per chart
- When exceeded, shows message indicating data is limited
- Affects the total number of plotted points after series filtering

**Bar Charts:**
- X-axis limiting based on available visual space
- Automatically calculates how many bars can fit given the chart width and bar grouping
- Can be overridden with `x.limit=N`

### Visual Cues for Limited Data

When data is limited, charts display informational messages:
- **Series limiting:** "Showing 12 of 45 series"
- **Data point limiting:** Indicates when data has been truncated

### Nested Chart Behavior

**Shared vs Independent Domains:**
- **Root/Global charts:** Use the globally calculated top N series
- **Nested charts:** May calculate their own local limits unless sharing is forced
- **Automatic sharing:** Domains are shared when ≤20 distinct values, otherwise independent

**Override Examples:**
```malloy
// Force showing all series (no limit)
# line_chart { series.limit=1000 }

// Use only top 5 series
# bar_chart { series.limit=5 }

// Force Y-axis sharing even with series limiting
# line_chart { series.limit=8 y.independent=false }

// Override bar chart X-axis limiting
# bar_chart { x.limit=15 }
```

---

## Layout & Structure Tags

### `# dashboard`

Arranges multiple nested views into a dashboard layout. Each nested view is rendered in its own tile.

**Properties:**

- `.table.max_height`: Sets a maximum pixel height for tables rendered within dashboard tiles. Useful for controlling layout with large tables. Set to `'none'` to disable max height.
  - Syntax: `# dashboard { table.max_height=400 }` or `# dashboard { table.max_height=none }`
- `# break` (applied to a nested view): Inserts a visual break in the dashboard layout, often forcing subsequent items onto a new row or section.

**Example:**

```
# dashboard
view: sales_overview is {
  nest: kpis is { select: total_sales, avg_margin } // Renders as text/single value

# break
nest: top_products_table is { // Renders as table
group_by: product
aggregate: total_sales
limit: 5
}

nest: sales_by_category_chart is { // Renders as bar chart
# bar_chart
group_by: category
aggregate: total_sales
}
}
```

### `# table`

Explicitly renders data as a table. This is often the default for nested results if no other renderer tag is specified.

**Properties:**

- `.flatten`: Flattens a _single-row_ nested record's fields into the parent table as columns. The nested query should not have `group_by`.
  - Syntax: `# flatten` (applied to the `nest:` definition)
- `.size=fill`: Makes the table attempt to fill the width of its container.
  - Syntax: `# table.size=fill`
- `# column` (applied to a specific field within the view): Controls individual column appearance.
  - `.width`: Sets column width. Accepts named sizes (`xs`, `sm`, `md`, `lg`, `xl`, `2xl`) or pixel values.
    - Syntax: `# column { width=lg }` or `# column { width=150 }`
  - `.height`: Sets a specific row height for cells in this column (in pixels).
    - Syntax: `# column { height=40 }`
  - `.word_break=break_all`: Allows long words/strings without spaces to break and wrap within the cell.
    - Syntax: `# column { word_break=break_all }`

**Examples:**

```
view: detailed_table is {
  group_by:
    category
    # column { width=lg } // Make brand column wider
    brand
  aggregate:
    total_sales

// Flatten metrics from a nested query
nest: metrics is { # flatten
aggregate: avg_price, total_cost
}

// Pivot sales by year
nest: sales_by_year is { # pivot
group_by: sale_year.year
aggregate: yearly_sales is sum(sales)
}
}
```

### `# list`

Renders the first non-hidden field of a nested result as a comma-separated list.

**Example:**

```
view: product_summary is {
  group_by: category
  # list
  nest: top_brands is {
    group_by: brand
    aggregate: total_sales
    order_by: 2 desc
    limit: 3
  }
}
// Output might look like: Clothing: Brand A, Brand B, Brand C
```

### `# list_detail`

Similar to `# list`, but uses the first two non-hidden fields to render items as `value (detail)`.

**Example:**

```
view: brand_counts is {
  group_by: category
  # list_detail
  nest: brand_details is {
    group_by: brand
    aggregate: num_products is count()
    order_by: 2 desc
    limit: 3
  }
}
// Output might look like: Clothing: Brand A (15), Brand B (12), Brand C (10)
```

### `# pivot`

Transforms a nested query into horizontal columns where dimension values become column headers. Instead of displaying a nested table, pivot creates columns for each unique combination of dimension values.

**Properties:**

- `.dimensions`: Specifies which fields to use as pivot dimensions (column headers). If not specified, all `group_by` fields are automatically used as dimensions.
  - Syntax: `# pivot { dimensions=[field1, field2] }`

**How It Works:**

- **Dimensions** (fields in `group_by`) become column headers
- **Measures** (fields in `aggregate`) become the cell values
- Each unique dimension value combination creates a set of columns
- Column headers display as "DimensionValue: measure_name" (e.g., "Men: total_sales")

**Limits:** Maximum of 30 pivot columns to ensure readable tables.

**Examples:**

```malloy
// Basic pivot - dimensions auto-detected from group_by
view: sales_by_category is {
  group_by: category
  aggregate: total_sales is sales.sum()

  # pivot
  nest: by_department is {
    group_by: department
    aggregate:
      avg_price is price.avg()
      total_units is units.sum()
  }
}
// Creates columns: Men: avg_price | Men: total_units | Women: avg_price | Women: total_units

// Explicit dimensions
view: regional_sales is {
  group_by: year
  # pivot { dimensions=[region] }
  nest: by_region is {
    group_by: region
    aggregate:
      total_sales is sales.sum()
      avg_margin is margin.avg()
  }
}
```

### `# transpose`

Rotates a table so that rows become columns and columns become rows. Useful for displaying multiple measures across categories in a more readable horizontal format.

**How It Works:**

- Original column names become row headers (displayed in the first column)
- Original row values become column headers
- Cell values are transposed accordingly

**Limits:** Maximum of 20 transpose columns.

**Example:**

```malloy
# transpose
view: metrics_summary is {
  group_by: category
  aggregate:
    avg_price is price.avg()
    total_sales is sales.sum()
    product_count is count()
}
```

Instead of:
| category  | avg_price | total_sales | product_count |
|-----------|-----------|-------------|---------------|
| Jeans     | 97.41     | 104,776     | 1,024         |
| Outerwear | 145.37    | 92,269      | 856           |

Displays as:
|               | Jeans  | Outerwear |
|---------------|--------|-----------|
| avg_price     | 97.41  | 145.37    |
| total_sales   | 104,776| 92,269    |
| product_count | 1,024  | 856       |

---

## Field-Level Formatting & Rendering Tags

These tags are typically applied directly to individual fields within a query.

### `# currency`

Formats a numeric field as currency (e.g., `$1,234.56`).

**Properties:**

- `. [unit]`: Specifies currency unit (`usd` (default), `euro`, `pound`). Can be specified like `# currency.euro` or `# currency=euro`.

**Example:**

```
measure: total_revenue is sales.sum() # currency
measure: euro_sales is sales.sum() # currency=euro
```

### `# percent`

Formats a numeric field as a percentage (value \* 100, adds %).

**Example:**

```
measure: margin_pct is (revenue - cost) / revenue # percent
```

### `# number`

Formats a numeric field using an `ssf` format string (e.g., Excel/Sheets formats).

**Properties:**

- `. [format]`: The format string.
  - Syntax: `# number="#,##0.00"`

**Example:**

```
measure: rounded_sales is sales.sum() # number="#,##0"
```

### `# duration`

Formats a numeric field representing a duration into a human-readable string (e.g., "1h 2m", "30s").

**Properties:**

- `. [unit]`: Specifies the unit of the input number if not seconds (e.g., `nanoseconds`, `milliseconds`, `minutes`, `hours`, `days`). Default is `seconds`.
  - Syntax: `# duration=milliseconds`
- `.terse`\*\*: Uses abbreviated units (ns, µs, ms, s, m, h, d).
  - Syntax: `# duration.terse` or `# duration { terse }`
- `.number`: Apply an `ssf` format string to the numeric parts of the duration.
  - Syntax: `# duration { number="0.0" }`

**Example:**

```
measure: avg_session_time is session_length.avg() # duration=seconds
measure: total_compute_time is compute_nanos.sum() # duration=nanoseconds terse
```

### `# image`

Renders a string field value as an image (`<img>` tag). Assumes the field contains a valid image URL.

**Properties:**

- `.height`: Sets the image height (e.g., `40px`).
  - Syntax: `# image { height=40px }`
- `.width`: Sets the image width.
  - Syntax: `# image { width=100px }`
- `.alt`: Specifies alt text for the image.
  - `.alt.[text]`: Sets literal alt text.
    - Syntax: `# image { alt=Logo }`
  - `.alt.field`: Uses the value of another field (specified by relative path like `brand_name` or `'../parent_field'`) for the alt text.
    - Syntax: `# image { alt.field=brand_name }`

**Example:**

```
dimension: product_image is image_url # image { height=50px alt.field=product_name }
```

### `# link`

Renders a field value as a hyperlink (`<a>` tag).

**Properties:**

- `.url_template`: A template string where `$$` is replaced by the value (from this field or the `.field` property) to form the `href`. If `$$` isn't present, the value is appended.
  - Syntax: `# link { url_template="https://example.com/products/$$" }`
- `.field`: Use the value from a _different_ field (specified by relative path) to substitute into `url_template` or use as the `href`. The original field's value is still used as the link text.
  - Syntax: `# link { url_template="https://.../$$" field=product_id }`

**Example:**

```
dimension: product_page is product_name # link { url_template="[https://example.com/products/$$](https://example.com/products/$$)" field=product_id }
dimension: product_id is ...
```

---

## Utility Tags

### `# hidden`

Hides a field from being rendered in tables or dashboards, though it remains in the data.

**Example:**

```
dimension: internal_id is id # hidden
```

### `# label`

Overrides the default display name (label/title) for a field or dashboard item.

**Example:**

```
measure: total_revenue is sales.sum() # label="Total Sales ($)"
```

### `# break`

Used within a `# dashboard` tag, applied to a `nest:`, to create a visual break (often forcing subsequent items onto a new line/section).

**Example:**

```
# dashboard
view: my_dashboard is {
  nest: kpi1 is { ... }
  nest: kpi2 is { ... }
  # break // Next item will likely start on a new row
  nest: main_chart is { ... }
}
```

### `# tooltip`

Marks a nested field/view to be included in the tooltip of its parent chart or visualization. Can also include rendering instructions for how the tooltip content itself should be rendered.

**Example:**

```
view: sales_by_brand_chart is {
  # bar_chart
  group_by: brand
  aggregate: total_sales

// Show top 3 products in the tooltip for each brand bar
nest: top_products is { # tooltip
group_by: product
aggregate: total_sales
order_by: 2 desc
limit: 3
}

// Show category count in tooltip, formatted as a tiny bar chart
nest: category_breakdown is { # tooltip bar_chart.size=xs
group_by: category
aggregate: num_items is count()
}
}
```

---

## Configuration Tags

### `# size`

_(Likely legacy, prefer `.size` property on specific renderer tags)_ Sets a preset size for some renderers (charts, tables) when applied at the view or nest level.

- Values: `spark`, `xs`, `sm`, `md`, `lg`, `xl`, `2xl`.
- Syntax: `# size=lg` (applied to a view or nest)

**Example:**

```
view: big_chart is {
  # size=lg // Apply large size to default renderer (likely table or chart)
  ...
}
```

### `# theme`

_(Model/View Level)_ Applies theme overrides to control styling (colors, fonts, sizes). Can be applied at the model level (`## theme { ... }`) for defaults or at the view level (`# theme { ... }`) for specific overrides.

**Properties:**

- _(Various CSS-like properties)_ e.g., `tableBodyColor`, `tableHeaderColor`, `tableRowHeight`, `fontFamily`.

**Example:**

```
## theme { tableBodyColor=blue } // Model-level default

source: my_source is ... extend {
view: my_view is {
# theme { tableBodyColor=red } // Override for this view
select: \*
}
}
```

### `# renderer_legacy`

_(Model Level)_ Applied at the top of a `.malloy` file using `## renderer_legacy` to indicate that the _entire_ model should use the older HTML table/chart renderers instead of the newer web component-based renderer.

**Example:**

```
## renderer_legacy

source: my_source is ...
```
